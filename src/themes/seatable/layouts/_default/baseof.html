<!doctype html>
<html
    lang="{{ site.Language.LanguageCode }}"
    dir="ltr"
    x-data="{ scrollPercent: 0 }"
    x-on:scroll.window="scrollPercent = Math.min(100, window.scrollY / (document.body.scrollHeight - window.innerHeight) * 100)">
    {{ partial "head/head.html" . }}


    <body class="font-roboto">
        <!-- Page Info: only for printed pages -->
        <div id="printer-footer" class="hidden border-b pb-4 print:block">
            <div class="flex flex-col items-start justify-between md:flex-row md:items-center">
                <span>URL: <strong>{{ .Permalink }}</strong></span>
                <span>Title: <strong>{{ .Title }}</strong></span>
                <span>Date: <strong>{{ now.Format "02.01.2006 15:04" }}</strong></span>
            </div>
        </div>

        <!-- Progress Bar (Fixed at top) -->
        <div class="fixed left-0 top-0 z-50 h-0.5 w-full bg-gray-200">
            <div class="h-full bg-seatable-orange transition-all duration-100" x-bind:style="`width: ${scrollPercent}%`"></div>
        </div>

        {{ if hugo.IsProduction }}
        {{ else }}
            {{ partial "tw-size-indicator.html" . }}
            <div class="fixed left-10 top-1 z-10 flex gap-3 print:hidden">
                <div><a href="/blocks/">{{ partial "icon.html" "palette" "palette" }}</a></div>
                <div><a href="/de/style-guide/">{{ partial "icon.html" "heart" "hearth" }}</a></div>
                <div><a href="/icons/">{{ partial "icon.html" "font-awesome" "font-aweseome" }}</a></div>
                <div><a href="/taxonomies/">{{ partial "icon.html" "list" "list" }}</a></div>
            </div>
        {{ end }}

        {{ if or (eq .Type "help") (eq .Type "help-start") }}
            {{ partial "header/basic-docs.html" . }}
        {{ else }}
            {{ partial "header/basic.html" . }}
        {{ end }}


        <!-- showCloud is necessary for price page - not beautiful but working... -->
        <main id="main-content" class="relative overflow-auto sm:overflow-visible" x-data="{ showCloud: true }">
            {{ block "main" . }}{{ end }}
        </main>

        <footer>
            {{ partial "footer.html" . }}
        </footer>

        <!-- cookie notification -->
        <div
            x-cloak
            x-data="{ 
                showCookie: !localStorage.getItem('cookies_accepted'),
                hideCookie() {
                    this.showCookie = false
                    localStorage.setItem('cookies_accepted', 'true')
                    
                    // PostHog Event
                    if (typeof posthog !== 'undefined') {
                        posthog.capture('cookies_accepted', {
                        cookie_banner_version: 'v1.0',
                        timestamp: new Date().toISOString()
                        })
                    }
                }
            }"
            x-show="showCookie"
            x-transition:leave="transition ease-in-out duration-300"
            x-transition:leave-start="opacity-100 translate-y-0"
            x-transition:leave-end="opacity-0 -translate-y-2 scale-95"
            class="fixed bottom-5 left-auto right-5 z-50 min-w-80 max-w-96 rounded-xl border border-gray-300 bg-white p-5 shadow-xl">
            <p class="text-sm text-gray-600">{{ T "cookies.text" }}</p>
            <div class="flex flex-row items-center justify-between gap-4 pt-4">
                <a href="{{ with .Site.GetPage "pages/legal/data-privacy" }}{{ .RelPermalink }}{{ end }}" class="text-sm text-blue-600">{{ T "cookies.link" }}</a>
                <button @click="hideCookie()" class="flex items-center rounded-lg bg-blue-600 px-4 py-2 text-white">
                    {{- partial "icon.html" "cookie-bite" -}}
                    <span class="pl-2 font-poppins text-sm font-bold">{{ T "cookies.confirm" }}</span>
                </button>
            </div>
        </div>

        <!-- formActions -->
        <script>
            /* form actions for registration and contact form */
            function contactForm() {
                return {
                    type: '',
                    teamname: '',
                    firstname: '',
                    lastname: '',
                    company: '',
                    orgType: 'business',
                    email: '',
                    phone: '',
                    url: '',
                    address: '',
                    country: '',
                    vatId: '',
                    products: [],
                    preferredLanguage: 'en',
                    reason: 'bug-report',
                    message: '',
                    // Honeypot field
                    name: '',
                    buttonText: '{{ T "contact.submit"}}',
                    isSubmitting: false, // Tracks if the form is being submitted
                    errorMessage: '', // Message to show on error
                    errors: {},
                    validateEmail() {
                        if (!this.email.trim()) {
                            this.errors.email = '{{ T "registration.email_required" }}';
                        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.email)) {
                            this.errors.email = '{{ T "registration.email_invalid" }}';
                        } else {
                            delete this.errors.email;
                        }
                    },
                    submitForm() {
                        this.validateEmail();

                        // Validate honeypot field
                        if (this.name.length >= 1) {
                            return;
                        }

                        // Disable the button
                        this.isSubmitting = true;
                        this.buttonText = '{{ T "contact.send" }}';

                        const url = '{{ getenv "HUGO_BACKEND_URL" }}';
                        const data = {
                            type: this.type,
                            teamname: this.teamname,
                            firstname: this.firstname,
                            lastname: this.lastname,
                            company: this.company,
                            orgType: this.orgType,
                            email: this.email,
                            phone: this.phone,
                            url: this.url,
                            address: this.address,
                            country: this.country,
                            vatId: this.vatId,
                            products: this.products,
                            preferredLanguage: this.preferredLanguage,
                            reason: this.reason,
                            message: this.message,
                        };

                        const headers = {
                            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                        };
                        const params = new URLSearchParams(data);

                        fetch(`${url}/submit`, {
                            method: 'POST',
                            headers: headers,
                            body: params.toString(),
                        })
                            .then((response) => response.json())
                            .then((data) => {
                                console.log(data);
                                if (data.success) {
                                    this.buttonText = '{{ partial "icon.html" "circle-check" }} {{ T "contact.success" }}';
                                    posthog.capture('Contact Form');
                                } else {
                                    this.errorMessage = data.error || 'error message'; // Show error message
                                    this.buttonText = '{{ partial "icon.html" "fire" }} {{ T "contact.error" }}'; // Reset button text
                                }
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                                this.errorMessage = error; // Show error message
                                this.buttonText = '{{ partial "icon.html" "fire" }} {{ T "contact.error" }}'; // Reset button text
                            })
                            .finally(() => {
                                //this.isSubmitting = false; // Enable the button again after completion
                            });

                    },
                };
            }

            function registrationForm() {
                return {
                    email: '',
                    // Honeypot field
                    name: '',
                    errors: {},
                    isSubmitting: false, // Tracks if the form is being submitted
                    successMessage: '', // Message to show on success
                    errorMessage: '', // Message to show on error
                    buttonText: '{{ T "registration.submit"}}',

                    validateEmail() {
                        if (!this.email.trim()) {
                            this.errors.email = '{{ T "registration.email_required" }}';
                        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.email)) {
                            this.errors.email = '{{ T "registration.email_invalid" }}';
                        } else {
                            delete this.errors.email;
                        }
                    },
                    submitForm() {
                        this.validateEmail();

                        if (this.errors.email) {
                            return;
                        }

                        // Validate honeypot field
                        if (this.name.length >= 1) {
                            return;
                        }

                        // Disable the button
                        this.isSubmitting = true;
                        this.buttonText = '{{ T "registration.send" }}';

                        const url = '{{ getenv "HUGO_BACKEND_URL" }}';
                        const data = {
                            email: this.email,
                            language: JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || DEFAULT_LANGUAGE,
                            next: localStorage.getItem('next') || '',
                        };

                        const headers = {
                            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                        };
                        const params = new URLSearchParams(data);

                        fetch(`${url}/register`, {
                            method: 'POST',
                            headers: headers,
                            body: params.toString(),
                        })
                            .then((response) => response.json())
                            .then((data) => {
                                console.log(data);
                                if (data.success) {
                                    this.buttonText = '{{ partial "icon.html" "circle-check" }} {{ T "registration.success" }}';
                                    posthog.capture('Cloud Registration');
                                } else {
                                    this.errorMessage = data.error || 'error message'; // Show error message
                                    this.buttonText = '{{ partial "icon.html" "fire" }} {{ T "registration.error" }}'; // Reset button text
                                }
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                                this.errorMessage = error; // Show error message
                                this.buttonText = '{{ partial "icon.html" "fire" }} {{ T "registration.error" }}'; // Reset button text
                            })
                            .finally(() => {
                                //this.isSubmitting = false; // Enable the button again after completion
                                localStorage.removeItem('next'); // Clear the saved 'next' parameter from localStorage
                            });
                    },
                };
            }

            function newsletterForm() {
                return {
                    email: '',
                    // Honeypot field
                    name: '',
                    errors: {},
                    isSubmitting: false,
                    submitted: false,
                    successMessage: '', // Message to show on success
                    errorMessage: '', // Message to show on error
                    buttonText: '{{ T "newsletter.submit"}}',

                    validateEmail() {
                        if (!this.email.trim()) {
                            this.errors.email = '{{ T "registration.email_required" }}';
                        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.email)) {
                            this.errors.email = '{{ T "registration.email_invalid" }}';
                        } else {
                            delete this.errors.email;
                        }
                    },
                    submitForm() {
                        this.validateEmail();

                        if (this.errors.email) {
                            return;
                        }

                        // Validate honeypot field
                        if (this.name.length >= 1) {
                            return;
                        }

                        // Disable the button
                        this.isSubmitting = true;
                        this.buttonText = '{{ T "newsletter.send" }}';

                        const url = '{{ getenv "HUGO_BACKEND_URL" }}';
                        const data = {
                            email: this.email,
                            language: JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || DEFAULT_LANGUAGE,
                        };

                        const headers = {
                            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                        };
                        const params = new URLSearchParams(data);

                        fetch(`${url}/subscribe`, {
                            method: 'POST',
                            headers: headers,
                            body: params.toString(),
                        })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.success) {
                                this.buttonText = '{{ partial "icon.html" "circle-check" }} {{ T "newsletter.success" }}';
                                posthog.capture('Newsletter Registration');
                            } else {
                                this.errorMessage = data.error || 'error message'; // Show error message
                                this.buttonText = '{{ partial "icon.html" "fire" }} {{ T "newsletter.error" }}'; // Reset button text
                            }
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                            this.errorMessage = error; // Show error message
                            this.buttonText = '{{ partial "icon.html" "fire" }} {{ T "newsletter.error" }}'; // Reset button text
                        })
                        .finally(() => {});
                    },
                };
            }

            function avvForm() {
                return {
                    // Form fields
                    responsible: '',
                    dataTypes: [],
                    otherData: '',
                    affectedPeople: [],
                    otherAffectedPeople: '',
                    // Honeypot field
                    name: '',
                    buttonText: 'AVV erzeugen',
                    isSubmitting: false,
                    errors: {},
                    submitForm() {
                        // Validate honeypot field
                        if (this.name.length >= 1) {
                            return;
                        }

                        // Disable the button
                        this.isSubmitting = true;
                        this.buttonText = 'Dokument wird erzeugt...';

                        const url = '{{ getenv "SEATABLE_INTERNAL_API_URL" }}';
                        const headers = {
                            'Content-Type': 'application/json'
                        };
                        const data = {
                            responsible: this.responsible,
                            dataTypes: this.dataTypes,
                            otherData: this.otherData,
                            affectedPeople: this.affectedPeople,
                            otherAffectedPeople: this.otherAffectedPeople,
                        };

                        fetch(`${url}/avv`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(data),
                        })
                            .then(async (response) => {
                                console.log(response);

                                if (!response.ok) {
                                    this.buttonText = '{{ partial "icon.html" "fire" }} {{ T "contact.error" }}';
                                    return;
                                }

                                // Create URL for Blob
                                const pdfUrl = URL.createObjectURL(await response.blob());

                                // Open PDF in new tab
                                window.open(pdfUrl, "_blank");

                                this.buttonText = 'Ihr Dokument wurde erzeugt!';
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                                this.buttonText = '{{ partial "icon.html" "fire" }} {{ T "contact.error" }}';
                            })
                            .finally(() => {
                                this.isSubmitting = false;
                            });
                    },
                };
            }
        </script>

        <!-- Language redirect -->
        <script>
            const SUPPORTED_LANGUAGES = ['en', 'de', 'es', 'fr', 'pt', 'ru'];
            const DEFAULT_LANGUAGE = 'en';
            const URL_BY_LANGUAGE = {};
            const LOCAL_STORAGE_KEY = 'hugo_language';

            {{ $urls := dict }}
            {{ range $.AllTranslations }}
                URL_BY_LANGUAGE['{{ .Lang }}'] = '{{ .Permalink }}';
                {{ $urls = merge $urls (dict "{{ .Lang }}" "{{ .Permalink }}") }}
            {{ end }}

            // Function to detect if the visitor is a search engine crawler
            function isCrawler() {
                const ua = navigator.userAgent;
                return /bot|crawl|slurp|spider|mediapartners/i.test(ua);
            }

            document.addEventListener('alpine:init', () => {
                const params = new URLSearchParams(window.location.search);

                // Check if the URL has a next parameter (passed from seatable cloud after base invitation)
                if (params.has('next')) {
                    const nextValue = params.get('next');
                    if (nextValue.startsWith('/dtable/links/') ||
                        nextValue.startsWith('/dtable/universal-app/links/')
                    ) {
                        localStorage.setItem('next', nextValue);
                    }
                }

                // Check if the URL has a force_language query parameter
                if (params.has('force_language')) {
                    // Update local storage
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(params.get('force_language')));
                    return;
                }

                // Skip redirect for crawlers/bots
                if (isCrawler()) {
                    return;
                }

                // Skip redirect if Matomo preview mode is enabled
                if (params.has('mtmPreviewMode')) {
                    return;
                }

                // Check local storage first
                const language = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY));

                if (language !== null) {
                    const target = URL_BY_LANGUAGE[language] || URL_BY_LANGUAGE[DEFAULT_LANGUAGE];

                    if (!target) {
                        // Do not try to redirect if the page does not exist in other languages
                        // This can happen with /categories/<name> since the categories are not linked
                        return;
                    }

                    redirect(target);
                    return;
                }

                const languages = navigator.languages || [navigator.language] || [DEFAULT_LANGUAGE];
                const languageCodes = languages.map((c) => c.split('-')[0]);

                // Find the first supported language (fallback to default language)
                const preferredLanguage = languageCodes.filter((code) => SUPPORTED_LANGUAGES.includes(code))[0] || DEFAULT_LANGUAGE;

                // Update local storage
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(preferredLanguage));

                const target = URL_BY_LANGUAGE[preferredLanguage] || URL_BY_LANGUAGE[DEFAULT_LANGUAGE];

                if (!target) {
                    // Do not try to redirect if the page does not exist in other languages
                    // This can happen with /categories/<name> since the categories are not linked
                    return;
                }

                redirect(target);
                return;
            });

            const redirect = (url) => {
                // Strip query parameters in order to not take them into account when comparing URLs
                const currentUrl = window.location.href.split('?')[0];

                // Redirect if the user is not already on the correct page
                if (currentUrl !== url) {
                    // Keep query parameters and URL fragment
                    window.location.href = url + window.location.search + window.location.hash;
                }
            };
        </script>

        <!-- alpine js -->
        {{ $collapse := resources.Get "js/alpineCollapse.js" | fingerprint }}
        <script src="{{ $collapse.RelPermalink }}" integrity="{{ $collapse.Data.Integrity }}" defer></script>

        {{ $persistPlugin := resources.Get "js/alpinePersist.js" | fingerprint }}
        <script src="{{ $persistPlugin.RelPermalink }}" integrity="{{ $persistPlugin.Data.Integrity }}" defer></script>

        {{ $alpine := resources.Get "js/alpine.js" | fingerprint }}
        <script src="{{ $alpine.RelPermalink }}" integrity="{{ $alpine.Data.Integrity }}" defer></script>

        <!-- matomo analytics -->
        {{ partial "matomo-analytics.html" . }}


        <!-- AB-Split Tests -->
        <script>
            function abTest() {
                return {
                    variant: Math.random() > 0.5 ? 'A' : 'B', // Randomly assign 'A' or 'B'
                };
            }
        </script>

        <!-- toc highlight -->
        {{ $toc := resources.Get "js/toc-highlight.js" | fingerprint }}
        <script src="{{ $toc.RelPermalink }}" integrity="{{ $toc.Data.Integrity }}" defer></script>
    </body>
</html>
