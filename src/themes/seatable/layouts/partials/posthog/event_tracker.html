{{- if hugo.IsServer -}}
    <!-- Don't add posthog to localhost -->
{{ else }}
    <script>
        // Capture pageview after redirect logic has run
        document.addEventListener('alpine:initialized', () => {
            // Capture pageview
            posthog.capture('$pageview');

            // Set up pageleave capture
            const handlePageLeave = () => {
                posthog.capture('$pageleave', null, { transport: 'sendBeacon' });
            };

            // Use pagehide if available for better reliability, otherwise fallback to unload
            const event = 'onpagehide' in window ? 'pagehide' : 'unload';
            window.addEventListener(event, handlePageLeave);
        });

        document.addEventListener('click', function (e) {
            const target = e.target.closest('[data-ph-capture-attribute-link-name], [data-ph-capture-event-name]'); // Erweitert um Event-Name-Selector

            if (target) {
                // Event-Name priorisieren (Fallback zu 'link_clicked')
                const eventNameAttr = target.getAttribute('data-ph-capture-event-name');
                const eventName = eventNameAttr || 'link_clicked';

                // Collect all data-ph-capture-attribute-* attributes
                const properties = {};
                Array.from(target.attributes).forEach((attr) => {
                    if (attr.name.startsWith('data-ph-capture-attribute-')) {
                        const propName = attr.name.replace('data-ph-capture-attribute-', '');
                        properties[propName] = attr.value;
                    }
                });

                posthog.capture(eventName, properties);
            }
        });
    </script>
{{ end }}
